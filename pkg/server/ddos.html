<!DOCTYPE html>
<html lang='it'>

<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>Network topology</title>
    <link href='./web/css/bootstrap/bootstrap.min.css' rel='stylesheet'>
    <script src='./web/js/bootstrap/bootstrap.bundle.min.js'></script>
    <script src="./web/js/jquery-3.6.0.min.js"></script>
    <!-- 
    <script src="./web/js/vis-network.min.js"></script>    
    -->
</head>

<body onload="handleTimer()">

    <!--    HEADER  -->
    <nav class='navbar navbar-expand-lg bg-light fixed-top'>
        <div class='container-fluid'>
            <button class='navbar-toggler' type='button' data-bs-toggle='collapse'
                data-bs-target='#navbarSupportedContent' aria-controls='navbarSupportedContent' aria-expanded='false'
                aria-label='Toggle navigation'>
                <span class='navbar-toggler-icon'></span>
            </button>
            <img src="./web/img/ulisse.jpeg" style="width:32px" />
            <div class='collapse navbar-collapse' id='navbarSupportedContent'>
                <ul class='navbar-nav me-auto mb-2 mb-lg-0'>
		    <li class='nav-item'>
                        <a class='nav-link active' aria-current='page' href='/'>
                            Home
                        </a>
                    </li>
                    <li class='nav-item'>
                        <a class='nav-link active' aria-current='page' href='/topology'>
                            Topology
                        </a>
                    </li>
                    <li class='nav-item'>
                        <a class='nav-link active' aria-current='page' href='/ddos'>
                            DDoS monitoring page
                        </a>
                    </li>
		</ul>
            </div>
        </div>
    </nav>
    <!--    FINE-HEADER   -->
    <div class='d-flex flex-column container-fluid align-items-center mt-5 mb-5'>
        <div class='col-12 row justify-content-center mt-4'>
            <div class='col-12 col-sm-6 col-lg-4 col-xl-3 mb-3 mt-lg-0 align-items-center'>
                <h2 class='mb-3'>DDoS monitoring:</h2>
                This page shows if a DDoS attack is happening
            </div>
            <div class='col-12 col-sm-3 col-lg-4 col-xl-4 mb-3 mt-lg-0 align-items-center'>
                <div class='mb-3'>
                    <h2>Status:</h2>
                    <p id='statusdiv'></p>
                </div>   
            </div>
            <div id='mystatus' class='col-12 col-sm-3 col-lg-4 col-xl-4 mb-3 mt-lg-0 align-items-center'>
                    <div id='mystatusparent'></div>
            </div>
        </div>
        <div class='col-12 row justify-content-center mt-4' style="height: 40%">          
        </div>
        <div class='col-12 row justify-content-center mt-4'>
            <div class='col-12 col-sm-6 col-lg-4 col-xl-4 mb-3 mt-lg-0 align-items-center'>
                <p id="suspectflows" style='font-size: 20pt'></p>
            </div>
            <div class='col-12 col-sm-6 col-lg-4 col-xl-4 mb-3 mt-lg-0 align-items-center'>
                <p id="droppedflows" style='font-size: 20pt'></p>
            </div>            
        </div>
        <div class='col-12 row align-items-baseline mt-4' style='position: fixed; bottom: 0; width: 100%;'>
            <div class='col-12 col-sm-6 col-lg-4 col-xl-3 mb-3 mt-lg-0'>
                <p>Monitor the suspect flows <a href="/getSuspectFlows">here</a>.</p>
            </div>
            <div class='col-12 col-sm-6 col-lg-4 col-xl-3 mb-3 mt-lg-0'>
            </div>
                        
        </div>
    </div>

    <script>

        var timerID
        $("#checkAutomaticUpdate").on("input", function(){
            if( $(this).is(":checked") )
                handleTimer()
            else
                clearTimeout(timerID)
        });
        
        // if reload page, firefox will let everything as it was before reload, so have to set it manually to default values
        $("#checkAutomaticUpdate").prop("checked", true );
        $("#secondsRange").val(10)

        function handleTimer() {
            $.ajax({
                url: "/getSuspectFlows",
                type: "GET",
                // The type of data we expect back
                dataType: "json",
            })
            // Code to run if the request succeeds:
                .done(function (json) {
                    displayAttackStatus(json)
                })
                // Code to run if the request fails:
                .fail(function (xhr, status, errorThrown) {
                    alert("Sorry, there was a problem getting the attack status");
                    console.log("Error: " + errorThrown);
                    console.log("Status: " + status);
                })
                // Code to run regardless of success or failure:
                .always(function (xhr, status) {
                    timerID = setTimeout(handleTimer, $("#secondsRange").val() * 1000);
                });

        }
        function displayAttackStatus(json) {
            // create a network
            //console.log(json.length)
            var statusdiv = document.getElementById('statusdiv');
            var parent = document.getElementById('mystatusparent');
            var toReplace = document.getElementById('mystatus');
            const container = parent.parentNode;
            
            var img = document.createElement("img");

            if(json.length == 0){
                statusdiv.textContent="The network is safe.";
                img.src = "./web/img/ok.png";
            } else{
                statusdiv.textContent="Warning! There may be an attack!";
                img.src = "./web/img/notok.png";

                var suspectflows = document.getElementById('suspectflows');
                //var suspectflowsnumber = document.getElementById('numbersuspect');
                var droppedflows = document.getElementById('droppedflows');
                //var droppedflowsnumber = document.getElementById('numberdropped');
                
                var suspect = 0;
                var dropped = 0;

                for (var i = 0; i < json.length; i++) {
                    // Iterate over numeric indexes from 0 to 5, as everyone expects.
                    if(String(json[i].Dropped).valueOf() == "false"){
                        suspect = suspect + 1;
                    } else{
                        dropped = dropped + 1;
                    }
                }

                suspectflows.innerHTML='There are ' +'<span style="color:orange;font-weight:bold;font-size:250%">'+ suspect +'</span>'+ ' suspect flows';
                droppedflows.innerHTML='There are ' +'<span style="color:red;font-weight:bold;font-size:250%">'+ dropped +'</span>'+ ' dropped flows';


            }

            parent.appendChild(img)

            container.replaceChild(toReplace,parent)
        }
    </script>

</body>


</html>
